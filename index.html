<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calorie Tracker</title>
  <link rel="stylesheet" href="style.css"> <!-- Link to your CSS file -->
</head>
<body>
  <div>
    <h1>Calorie Tracker</h1>
    
    <!-- Info Text Box -->
    <div class="info-box">
      1kg = 7700 kcal deficit, and daily calorie intake = 2400 kcal
    </div>

    <!-- Toggle button to show/hide the login menu -->
    <button id="toggle-login-menu" class="toggle-button">Show Login/Register</button>

    <!-- Login/Registration Dropdown Menu -->
    <div id="login-menu" class="login-menu">
      <!-- Google Sign-In Button -->
      <div>
        <button id="google-signin-btn" class="button">Sign in with Google</button>
      </div>

      <!-- Email/Password Login Form -->
      <h3>Login with Email</h3>
      <div>
        <input type="email" id="login-email" class="input-field" placeholder="Email" />
        <input type="password" id="login-password" class="input-field" placeholder="Password" />
        <button id="login-btn" class="button">Login</button>
      </div>

      <!-- Email/Password Registration Form -->
      <h3>Register with Email</h3>
      <div>
        <input type="email" id="register-email" class="input-field" placeholder="Email" />
        <input type="password" id="register-password" class="input-field" placeholder="Password" />
        <button id="register-btn" class="button">Register</button>
      </div>

      <!-- Logout Button -->
      <div>
        <button id="logout-btn" class="button">Logout</button>
      </div>

      <!-- Auth Status -->
      <div id="auth-status">Not logged in</div>
    </div>

    <!-- Container for meal buttons, total calories, and deficit data -->
    <div id="meal-container"></div>
    <div id="daily-total">Daily Total: 0 kcal</div>

    <!-- Buttons for saving data and showing monthly deficit -->
    <button id="save-data-btn" class="button">Save Today's Data</button>
    <button id="show-monthly-btn" class="button">Show Monthly Deficit</button>

    <script type="module">
      // Firebase and Firestore imports
      import { db } from './firebase.js';
      import { meals } from './meals.js';
      import { collection, doc, getDoc, setDoc, getDocs } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-firestore.js";
      import { auth, provider } from './firebase.js';
      import { signInWithRedirect, getRedirectResult, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-auth.js";
      import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-auth.js";

      let dailyTotal = 0;
      const dailyLimit = 2400;
      const oneKgDeficit = 7700;

      // Handle the result after Google Sign-In Redirect
      async function handleRedirectResult() {
        try {
          const result = await getRedirectResult(auth);
          if (result) {
            const user = result.user;
            alert(`Signed in as ${user.displayName}`);
          }
        } catch (error) {
          console.error("Error handling redirect result: ", error);
        }
      }

      // Load daily and monthly calorie deficit from Firestore
      async function loadCalorieData() {
        const user = auth.currentUser;
        if (!user) {
          alert('You must be logged in to load data.');
          return;
        }

        const today = new Date().toLocaleDateString();

        // Load the daily data for the current day
        const dailyDocRef = doc(db, `users/${user.uid}/calorieData`, today);
        const dailyDocSnap = await getDoc(dailyDocRef);

        if (dailyDocSnap.exists()) {
          const data = dailyDocSnap.data();
          dailyTotal = data.total;
          document.getElementById('daily-total').textContent = `Daily Total: ${dailyTotal} kcal (Deficit: ${dailyLimit - dailyTotal} kcal)`;
          highlightEatenMeals(data.eatenMeals || []);
        } else {
          // No daily data yet for today
          dailyTotal = 0;
          document.getElementById('daily-total').textContent = `Daily Total: 0 kcal (Deficit: ${dailyLimit} kcal)`;
        }

        // Load the monthly deficit data (for example purposes)
        const monthlyDocRef = doc(db, `users/${user.uid}/calorieData`, 'monthly');
        const monthlyDocSnap = await getDoc(monthlyDocRef);

        if (monthlyDocSnap.exists()) {
          alert(`Monthly deficit so far: ${monthlyDocSnap.data().monthlyDeficit} kcal`);
        } else {
          alert('No monthly data available yet.');
        }
      }

      // Save daily data (overwrite today's record)
      async function saveDailyData() {
        const user = auth.currentUser;
        if (!user) {
          alert('You must be logged in to save data.');
          return;
        }

        const deficit = dailyLimit - dailyTotal;
        const today = new Date().toLocaleDateString();

        try {
          // Update or create the document for today's date
          await setDoc(doc(db, `users/${user.uid}/calorieData`, today), {
            date: today,
            total: dailyTotal,
            deficit: deficit,
            eatenMeals: selectedMeals
          });

          // Update or create the monthly deficit record
          const monthlyDocRef = doc(db, `users/${user.uid}/calorieData`, 'monthly');
          const monthlyDocSnap = await getDoc(monthlyDocRef);
          let monthlyDeficit = deficit;

          if (monthlyDocSnap.exists()) {
            monthlyDeficit += monthlyDocSnap.data().monthlyDeficit;
          }

          await setDoc(monthlyDocRef, { monthlyDeficit });

          alert('Data saved successfully');
        } catch (error) {
          console.error("Error saving document: ", error);
          alert('Failed to save data');
        }
      }

      // Track selected meals for the day
      let selectedMeals = [];

      function addCalories(meal) {
        dailyTotal += meal.calories;
        selectedMeals.push(meal.name);
        updateDailyTotal();
      }

      function highlightEatenMeals(eatenMeals) {
        selectedMeals = eatenMeals;
        eatenMeals.forEach(mealName => {
          const button = document.querySelector(`[data-meal="${mealName}"]`);
          if (button) {
            button.classList.add('selected');
          }
        });
      }

      function updateDailyTotal() {
        document.getElementById('daily-total').textContent = `Daily Total: ${dailyTotal} kcal (Deficit: ${dailyLimit - dailyTotal} kcal)`;
      }

      // Render meal buttons dynamically
      function renderMealButtons() {
        const mealContainer = document.getElementById('meal-container');
        meals.forEach(meal => {
          const button = document.createElement('button');
          button.textContent = `${meal.name} - ${meal.calories} kcal`;
          button.className = "button";
          button.dataset.meal = meal.name;
          button.onclick = () => {
            addCalories(meal);
            button.classList.add('selected');
          };
          mealContainer.appendChild(button);
        });
      }

      // Initialize buttons and event listeners
      document.addEventListener('DOMContentLoaded', () => {
        handleRedirectResult(); // Handle Google redirect result on page load
        renderMealButtons();
        loadCalorieData(); // Load existing daily and monthly data

        document.getElementById('save-data-btn').addEventListener('click', saveDailyData);
        document.getElementById('show-monthly-btn').addEventListener('click', loadCalorieData);

        // Add event listeners for login and register buttons
        document.getElementById('login-btn').addEventListener('click', () => {
          const email = document.getElementById('login-email').value;
          const password = document.getElementById('login-password').value;
          loginUser(email, password);
        });

        document.getElementById('register-btn').addEventListener('click', () => {
          const email = document.getElementById('register-email').value;
          const password = document.getElementById('register-password').value;
          registerUser(email, password);
        });

        document.getElementById('logout-btn').addEventListener('click', logoutUser);
      });
    </script>
  </div>
</body>
</html>
