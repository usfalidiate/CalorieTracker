<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calorie Tracker</title>
  <link rel="stylesheet" href="style.css"> <!-- Optional: Add your CSS file here -->
</head>
<body>
  <div>
    <h1>Calorie Tracker</h1>

    <!-- Google Sign-In Button -->
    <div>
      <button id="google-signin-btn" class="button">Sign in with Google</button>
    </div>

    <!-- Email/Password Login Form -->
    <h3>Login with Email</h3>
    <div>
      <input type="email" id="login-email" placeholder="Email" />
      <input type="password" id="login-password" placeholder="Password" />
      <button id="login-btn" class="button">Login</button>
    </div>

    <!-- Email/Password Registration Form -->
    <h3>Register with Email</h3>
    <div>
      <input type="email" id="register-email" placeholder="Email" />
      <input type="password" id="register-password" placeholder="Password" />
      <button id="register-btn" class="button">Register</button>
    </div>

    <!-- Logout Button -->
    <div>
      <button id="logout-btn" class="button">Logout</button>
    </div>

    <!-- Auth Status -->
    <div id="auth-status">Not logged in</div>

    <!-- Container for meal buttons -->
    <div id="meal-container"></div>

    <!-- Display total calories and deficit -->
    <div id="daily-total">Daily Total: 0 kcal</div>

    <!-- Buttons for saving data and showing monthly deficit -->
    <button id="save-data-btn" class="button">Save Today's Data</button>
    <button id="show-monthly-btn" class="button">Show Monthly Deficit</button>

    <script type="module">
      // Firebase and Firestore imports
      import { db } from './firebase.js';
      import { meals } from './meals.js';
      import { collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-firestore.js";
      import { auth, provider } from './firebase.js';
      import { signInWithRedirect, getRedirectResult, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-auth.js";
      import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-auth.js";

      // Google Sign-In with Redirect
      export async function signInWithGoogle() {
        try {
          await signInWithRedirect(auth, provider);
        } catch (error) {
          alert("Error signing in: " + error.message);
        }
      }

      // Handle the result after Google Redirect
      export async function handleRedirectResult() {
        try {
          const result = await getRedirectResult(auth);
          if (result) {
            const user = result.user;
            alert("Signed in as " + user.displayName);
          }
        } catch (error) {
          console.error("Error handling redirect result: ", error);
        }
      }

      // Register new user with Email/Password
      export async function registerUser(email, password) {
        try {
          const userCredential = await createUserWithEmailAndPassword(auth, email, password);
          const user = userCredential.user;
          alert("Registration successful for user: " + user.email);
        } catch (error) {
          alert("Error registering: " + error.message);
        }
      }

      // Login with Email/Password
      export async function loginUser(email, password) {
        try {
          const userCredential = await signInWithEmailAndPassword(auth, email, password);
          const user = userCredential.user;
          alert("Login successful for user: " + user.email);
        } catch (error) {
          alert("Error logging in: " + error.message);
        }
      }

      // Logout Function
      export async function logoutUser() {
        try {
          await signOut(auth);
          alert("You have logged out.");
        } catch (error) {
          alert("Error logging out: " + error.message);
        }
      }

      // Monitor Auth State
      onAuthStateChanged(auth, (user) => {
        if (user) {
          document.getElementById('auth-status').textContent = `Logged in as ${user.displayName || user.email}`;
        } else {
          document.getElementById('auth-status').textContent = "Not logged in";
        }
      });

      // Variables for daily calorie tracking
      let dailyTotal = 0;
      const dailyLimit = 2100;

      // Function to add calories and update the display
      function addCalories(calories) {
        dailyTotal += calories;
        updateDailyTotal();
      }

      function updateDailyTotal() {
        document.getElementById('daily-total').textContent = `Daily Total: ${dailyTotal} kcal (Deficit: ${dailyLimit - dailyTotal} kcal)`;
      }

      // Save daily data to Firestore for the logged-in user
      async function saveDailyData() {
        const user = auth.currentUser;
        if (!user) {
          alert('You must be logged in to save data.');
          return;
        }

        const deficit = dailyLimit - dailyTotal;
        const date = new Date().toLocaleDateString();

        try {
          await addDoc(collection(db, `users/${user.uid}/calorieData`), {
            date: date,
            total: dailyTotal,
            deficit: deficit
          });
          alert('Data saved successfully');
        } catch (error) {
          console.error("Error saving document: ", error);
          alert('Failed to save data');
        }
      }

      // Show monthly calorie deficit data for the logged-in user only
      async function showMonthlyDeficit() {
        const user = auth.currentUser;
        if (!user) {
          alert('You must be logged in to view your data.');
          return;
        }

        try {
          const querySnapshot = await getDocs(collection(db, `users/${user.uid}/calorieData`));
          let results = "";
          querySnapshot.forEach((doc) => {
            const data = doc.data();
            results += `Date: ${data.date}, Deficit: ${data.deficit} kcal\n`;
          });
          if (results) {
            alert(results);
          } else {
            alert("No data available for this user.");
          }
        } catch (error) {
          console.error("Error retrieving documents: ", error);
          alert('Failed to fetch data');
        }
      }

      // Render meal buttons dynamically
      function renderMealButtons() {
        const mealContainer = document.getElementById('meal-container');
        meals.forEach(meal => {
          const button = document.createElement('button');
          button.textContent = `${meal.name} - ${meal.calories} kcal`;
          button.className = "button";
          button.onclick = () => addCalories(meal.calories);
          mealContainer.appendChild(button);
        });
      }

      // Initialize buttons and event listeners
      document.addEventListener('DOMContentLoaded', () => {
        handleRedirectResult(); // Handle Google redirect result on page load
        renderMealButtons();
        document.getElementById('save-data-btn').addEventListener('click', saveDailyData);
        document.getElementById('show-monthly-btn').addEventListener('click', showMonthlyDeficit);
      });
    </script>
  </div>
</body>
</html>
